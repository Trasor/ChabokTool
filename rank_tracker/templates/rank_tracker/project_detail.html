{% extends 'layout/layout.html' %}
{% load static %}

{% block title %}{{ project.project_name }} - جزئیات پروژه{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- هدر پروژه -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1 text-gray-800">{{ project.project_name }}</h1>
                    <p class="text-muted mb-0">
                        <i class="ri-global-line"></i> {{ project.target_domain }}
                    </p>
                </div>
                <div>
                    <a href="{% url 'rank_tracker:project_list' %}" class="btn btn-secondary">
                        <i class="ri-arrow-right-line"></i> بازگشت
                    </a>
                    <a href="{% url 'rank_tracker:keyword_add' project.id %}" class="btn btn-success">
                        <i class="ri-add-line"></i> افزودن کلمات
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- آمار پروژه -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-left-primary shadow h-100">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                کلمات کلیدی
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ project.keywords_count }} / {{ project.keyword_capacity }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="ri-key-2-line ri-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-left-success shadow h-100">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                آپدیت این ماه
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ project.update_count_current_month }} / 4
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="ri-refresh-line ri-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-left-info shadow h-100">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                آخرین آپدیت
                            </div>
                            <div class="h6 mb-0 font-weight-bold text-gray-800">
                                {% if project.last_update_at %}
                                    {{ project.last_update_at|date:"Y-m-d H:i" }}
                                {% else %}
                                    هنوز آپدیت نشده
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="ri-calendar-line ri-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-left-warning shadow h-100">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                ظرفیت باقیمانده
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ project.keyword_capacity|add:"-"|add:project.keywords_count }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="ri-database-2-line ri-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- دکمه آپدیت رتبه‌ها -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    {% if project.can_update %}
                        <form method="post" action="{% url 'rank_tracker:update_ranks' project.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-primary btn-lg" onclick="return confirm('آیا از آپدیت رتبه‌ها اطمینان دارید؟')">
                                <i class="ri-refresh-line"></i> آپدیت رتبه‌ها
                            </button>
                        </form>
                        <span class="text-muted ms-3">
                            <i class="ri-information-line"></i>
                            {{ project.update_count_current_month|add:"-4"|add:"4" }} آپدیت باقی‌مانده در این ماه
                        </span>
                    {% else %}
                        <button class="btn btn-secondary btn-lg" disabled>
                            <i class="ri-forbid-line"></i> محدودیت ماهانه تمام شد
                        </button>
                        <span class="text-danger ms-3">
                            <i class="ri-alert-line"></i>
                            محدودیت 4 آپدیت در ماه به پایان رسیده. ماه بعد دوباره فعال می‌شود.
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- جدول کلمات کلیدی -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">لیست کلمات کلیدی</h5>
                </div>
                <div class="card-body">
                    {% if keywords %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>#</th>
                                        <th>کلمه کلیدی</th>
                                        <th>رتبه فعلی</th>
                                        <th>رتبه قبلی</th>
                                        <th>تغییر</th>
                                        <th>بهترین رتبه</th>
                                        <th>صفحه</th>
                                        <th>نمودار</th>
                                        <th>عملیات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for keyword in keywords %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td><strong>{{ keyword.keyword }}</strong></td>
                                        <td>
                                            {% if keyword.current_rank %}
                                                <span class="badge bg-primary">{{ keyword.current_rank }}</span>
                                            {% else %}
                                                <span class="badge bg-secondary">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if keyword.previous_rank %}
                                                <span class="badge bg-info">{{ keyword.previous_rank }}</span>
                                            {% else %}
                                                <span class="badge bg-secondary">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if keyword.rank_change %}
                                                {% if keyword.rank_change > 0 %}
                                                    <span class="text-success">
                                                        <i class="ri-arrow-up-line"></i> +{{ keyword.rank_change }}
                                                    </span>
                                                {% elif keyword.rank_change < 0 %}
                                                    <span class="text-danger">
                                                        <i class="ri-arrow-down-line"></i> {{ keyword.rank_change }}
                                                    </span>
                                                {% else %}
                                                    <span class="text-muted">
                                                        <i class="ri-subtract-line"></i> 0
                                                    </span>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if keyword.highest_rank %}
                                                <span class="badge bg-success">{{ keyword.highest_rank }}</span>
                                            {% else %}
                                                <span class="badge bg-secondary">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if keyword.page_number %}
                                                صفحه {{ keyword.page_number }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary"
                                                    onclick="showChart({{ keyword.id }}, '{{ keyword.keyword|escapejs }}')">
                                                <i class="ri-line-chart-line"></i> نمودار
                                            </button>
                                        </td>
                                        <td>
                                            <a href="{% url 'rank_tracker:keyword_delete' keyword.id %}"
                                               class="btn btn-sm btn-danger"
                                               onclick="return confirm('آیا از حذف این کلمه اطمینان دارید؟')">
                                                <i class="ri-delete-bin-line"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <h5><i class="ri-information-line"></i> هنوز کلمه‌ای اضافه نشده!</h5>
                            <p class="mb-0">برای شروع، چند کلمه کلیدی اضافه کنید.</p>
                            <a href="{% url 'rank_tracker:keyword_add' project.id %}" class="btn btn-primary mt-3">
                                <i class="ri-add-line"></i> افزودن اولین کلمه
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- حذف پروژه -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="ri-alert-line"></i> منطقه خطرناک</h5>
                </div>
                <div class="card-body">
                    <p>حذف پروژه غیرقابل بازگشت است. تمام کلمات کلیدی و تاریخچه رتبه‌ها حذف خواهند شد.</p>
                    <a href="{% url 'rank_tracker:project_delete' project.id %}" class="btn btn-danger">
                        <i class="ri-delete-bin-line"></i> حذف پروژه
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal برای نمایش Chart -->
<div class="modal fade" id="chartModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="chartModalLabel">تاریخچه رتبه</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="chart"></div>
            </div>
        </div>
    </div>
</div>

<!-- ApexCharts -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
let chartInstance = null;

function showChart(keywordId, keywordText) {
    // دریافت داده‌های Chart از API
    fetch(`/rank-tracker/api/keyword-history/${keywordId}/`)
        .then(response => response.json())
        .then(data => {
            // نمایش Modal
            const modal = new bootstrap.Modal(document.getElementById('chartModal'));
            document.getElementById('chartModalLabel').textContent = `تاریخچه رتبه: ${keywordText}`;
            modal.show();

            // پاک کردن Chart قبلی
            if (chartInstance) {
                chartInstance.destroy();
            }

            // ساخت Chart جدید
            const options = {
                series: [{
                    name: 'رتبه',
                    data: data.ranks
                }],
                chart: {
                    type: 'line',
                    height: 350,
                    fontFamily: 'IRANSans, sans-serif',
                    toolbar: {
                        show: true
                    }
                },
                stroke: {
                    curve: 'smooth',
                    width: 3
                },
                xaxis: {
                    categories: data.dates,
                    title: {
                        text: 'تاریخ'
                    }
                },
                yaxis: {
                    reversed: true,
                    title: {
                        text: 'رتبه'
                    },
                    min: 1,
                    max: 100
                },
                markers: {
                    size: 5
                },
                colors: ['#0d6efd'],
                title: {
                    text: `تاریخچه رتبه: ${keywordText}`,
                    align: 'center'
                },
                tooltip: {
                    y: {
                        formatter: function(value) {
                            return `رتبه ${value}`;
                        }
                    }
                }
            };

            chartInstance = new ApexCharts(document.querySelector("#chart"), options);
            chartInstance.render();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('خطا در دریافت داده‌های نمودار');
        });
}
</script>
{% endblock %}
