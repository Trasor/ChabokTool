{% extends 'layout/layout.html' %}
{% load static %}
{% load jalali_tags %}

{% block title %}{{ project.project_name }} - جزئیات پروژه{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- هدر پروژه -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1 text-gray-800">{{ project.project_name }}</h1>
                    <p class="text-muted mb-0">
                        <i class="ri-global-line"></i> {{ project.target_domain }}
                    </p>
                </div>
                <div>
                    <a href="{% url 'rank_tracker:project_list' %}" class="btn btn-secondary">
                        <i class="ri-arrow-right-line"></i> بازگشت
                    </a>
                    <a href="{% url 'rank_tracker:keyword_add' project.id %}" class="btn btn-success">
                        <i class="ri-add-line"></i> افزودن کلمات
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- آمار پروژه -->
    <div class="row mb-4">
        <div class="col-lg-4 col-md-4 col-12 mb-3">
            <div class="card border-left-primary shadow h-100">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                کلمات کلیدی
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ project.keywords_count }} / {{ project.keyword_capacity }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="ri-key-2-line ri-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-4 col-12 mb-3">
            <div class="card border-left-success shadow h-100">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                آپدیت این ماه
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ project.update_count_current_month }} / 4
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="ri-refresh-line ri-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6 mb-3">
            <div class="card border-left-info shadow h-100">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                آخرین آپدیت
                            </div>
                            <div class="h6 mb-0 font-weight-bold text-gray-800">
                                {% if project.last_update_at %}
                                    {{ project.last_update_at|jalali_datetime }}
                                {% else %}
                                    هنوز آپدیت نشده
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="ri-calendar-line ri-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- دکمه‌های آپدیت -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="post" id="updateForm" action="{% url 'rank_tracker:update_ranks' project.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="selected_keywords" id="selectedKeywords" value="">

                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                            <div>
                                {% if project.can_update %}
                                    <button type="submit" name="update_type" value="all" class="btn btn-primary btn-lg" onclick="return confirm('آیا از آپدیت همه کلمات اطمینان دارید؟')">
                                        <i class="ri-refresh-line"></i> آپدیت همه
                                    </button>
                                    <button type="button" class="btn btn-success btn-lg" onclick="updateSelected()">
                                        <i class="ri-checkbox-multiple-line"></i> آپدیت انتخاب شده‌ها
                                    </button>
                                    <span class="text-muted ms-3">
                                        <i class="ri-information-line"></i>
                                        {{ project.update_count_current_month|add:"-4"|add:"4" }} آپدیت باقی‌مانده
                                    </span>
                                {% else %}
                                    <button class="btn btn-secondary btn-lg" disabled>
                                        <i class="ri-forbid-line"></i> محدودیت ماهانه تمام شد
                                    </button>
                                    <span class="text-danger ms-3">
                                        <i class="ri-alert-line"></i>
                                        محدودیت 4 آپدیت در ماه به پایان رسیده
                                    </span>
                                {% endif %}
                            </div>

                            <!-- فیلترهای تاریخی -->
                            <div class="d-flex gap-2 flex-wrap">
                                <select class="form-select" id="dateFilter" onchange="filterByDate()">
                                    <option value="all" {% if days_filter == 'all' %}selected{% endif %}>از اول تا کنون</option>
                                    <option value="30" {% if days_filter == '30' %}selected{% endif %}>از ماه گذشته تا الان</option>
                                    <option value="15" {% if days_filter == '15' %}selected{% endif %}>از 15 روز گذشته تا الان</option>
                                    <option value="7" {% if days_filter == '7' %}selected{% endif %}>از 7 روز گذشته تا الان</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- جدول کلمات کلیدی -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">لیست کلمات کلیدی</h5>
                </div>
                <div class="card-body">
                    {% if keywords %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="keywordsTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width: 50px; text-align: center;">
                                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)" style="cursor: pointer; width: 18px; height: 18px; border: 2px solid #333; accent-color: #0d6efd;">
                                        </th>
                                        <th>کلمه کلیدی</th>
                                        <th>رتبه فعلی</th>
                                        <th>رتبه قبلی</th>
                                        <th>تغییر</th>
                                        <th>بهترین رتبه</th>
                                        <th>صفحه</th>
                                        <th>صفحه رتبه‌گرفته</th>
                                        <th>نمودار</th>
                                        <th>عملیات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for keyword in keywords %}
                                    <tr data-keyword-id="{{ keyword.id }}">
                                        <td style="text-align: center;">
                                            <input type="checkbox" class="keyword-checkbox" value="{{ keyword.id }}" style="cursor: pointer; width: 18px; height: 18px; border: 2px solid #333; accent-color: #0d6efd;">
                                        </td>
                                        <td><strong>{{ keyword.keyword }}</strong></td>
                                        <td>
                                            {% if keyword.current_rank %}
                                                <span class="badge bg-primary">{{ keyword.current_rank }}</span>
                                            {% else %}
                                                <span class="badge bg-secondary">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if keyword.previous_rank %}
                                                <span class="badge bg-info">{{ keyword.previous_rank }}</span>
                                            {% else %}
                                                <span class="badge bg-secondary">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if keyword.filtered_rank_change is not None %}
                                                {% if keyword.filtered_rank_change > 0 %}
                                                    <span class="text-success">
                                                        <i class="ri-arrow-up-line"></i> +{{ keyword.filtered_rank_change }}
                                                    </span>
                                                {% elif keyword.filtered_rank_change < 0 %}
                                                    <span class="text-danger">
                                                        <i class="ri-arrow-down-line"></i> {{ keyword.filtered_rank_change }}
                                                    </span>
                                                {% else %}
                                                    <span class="text-muted">
                                                        <i class="ri-subtract-line"></i> 0
                                                    </span>
                                                {% endif %}
                                            {% elif keyword.rank_change %}
                                                {% if keyword.rank_change > 0 %}
                                                    <span class="text-success">
                                                        <i class="ri-arrow-up-line"></i> +{{ keyword.rank_change }}
                                                    </span>
                                                {% elif keyword.rank_change < 0 %}
                                                    <span class="text-danger">
                                                        <i class="ri-arrow-down-line"></i> {{ keyword.rank_change }}
                                                    </span>
                                                {% else %}
                                                    <span class="text-muted">
                                                        <i class="ri-subtract-line"></i> 0
                                                    </span>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if keyword.filtered_highest_rank %}
                                                <span class="badge bg-success">{{ keyword.filtered_highest_rank }}</span>
                                            {% elif keyword.highest_rank %}
                                                <span class="badge bg-success">{{ keyword.highest_rank }}</span>
                                            {% else %}
                                                <span class="badge bg-secondary">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if keyword.page_number %}
                                                صفحه {{ keyword.page_number }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if keyword.ranked_url and keyword.ranked_page_title %}
                                                <a href="{{ keyword.ranked_url }}" target="_blank" class="text-primary" title="{{ keyword.ranked_page_title }}">
                                                    {{ keyword.ranked_page_title|truncatechars:40 }}
                                                    <i class="ri-external-link-line"></i>
                                                </a>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary"
                                                    onclick="showChart({{ keyword.id }}, '{{ keyword.keyword|escapejs }}')">
                                                <i class="ri-line-chart-line"></i>
                                            </button>
                                        </td>
                                        <td>
                                            <a href="{% url 'rank_tracker:keyword_delete' keyword.id %}"
                                               class="btn btn-sm btn-danger"
                                               onclick="return confirm('آیا از حذف این کلمه اطمینان دارید؟')">
                                                <i class="ri-delete-bin-line"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <h5><i class="ri-information-line"></i> هنوز کلمه‌ای اضافه نشده!</h5>
                            <p class="mb-0">برای شروع، چند کلمه کلیدی اضافه کنید.</p>
                            <a href="{% url 'rank_tracker:keyword_add' project.id %}" class="btn btn-primary mt-3">
                                <i class="ri-add-line"></i> افزودن اولین کلمه
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal برای نمایش Chart -->
<div class="modal fade" id="chartModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="chartModalLabel">تاریخچه رتبه</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="chart"></div>
            </div>
        </div>
    </div>
</div>

<!-- ApexCharts -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<!-- Moment.js (required for moment-jalaali) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

<!-- جلالی -->
<script src="https://cdn.jsdelivr.net/npm/moment-jalaali@0.9.6/moment-jalaali.min.js"></script>

<script>
let chartInstance = null;

// انتخاب همه
function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.keyword-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
}

// آپدیت انتخاب شده‌ها
function updateSelected() {
    const checkboxes = document.querySelectorAll('.keyword-checkbox:checked');
    if (checkboxes.length === 0) {
        alert('لطفا حداقل یک کلمه کلیدی را انتخاب کنید');
        return;
    }

    if (!confirm(`آیا از آپدیت ${checkboxes.length} کلمه کلیدی اطمینان دارید؟`)) {
        return;
    }

    const ids = Array.from(checkboxes).map(cb => cb.value);
    document.getElementById('selectedKeywords').value = ids.join(',');

    const form = document.getElementById('updateForm');
    const updateType = document.createElement('input');
    updateType.type = 'hidden';
    updateType.name = 'update_type';
    updateType.value = 'selected';
    form.appendChild(updateType);
    form.submit();
}

// فیلتر تاریخی
function filterByDate() {
    const days = document.getElementById('dateFilter').value;
    const currentUrl = new URL(window.location);

    if (days === 'all') {
        currentUrl.searchParams.delete('days');
    } else {
        currentUrl.searchParams.set('days', days);
    }

    window.location.href = currentUrl.toString();
}

// نمایش Chart
function showChart(keywordId, keywordText) {
    fetch(`/rank-tracker/api/keyword-history/${keywordId}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Chart data received:', data);

            // بررسی داده‌ها
            if (!data.dates || data.dates.length === 0) {
                alert('هنوز تاریخچه‌ای برای این کلمه ثبت نشده است.');
                return;
            }

            const modal = new bootstrap.Modal(document.getElementById('chartModal'));
            document.getElementById('chartModalLabel').textContent = `تاریخچه رتبه: ${keywordText}`;
            modal.show();

            if (chartInstance) {
                chartInstance.destroy();
            }

            // تبدیل تاریخ‌ها به فارسی
            const persianDates = data.dates.map(date => {
                return moment(date, 'YYYY-MM-DD').format('jYYYY/jMM/jDD');
            });

            const options = {
                series: [{
                    name: 'رتبه',
                    data: data.ranks
                }],
                chart: {
                    type: 'line',
                    height: 350,
                    fontFamily: 'IRANSans, sans-serif',
                    toolbar: {
                        show: true
                    }
                },
                stroke: {
                    curve: 'smooth',
                    width: 3
                },
                xaxis: {
                    categories: persianDates,
                    title: {
                        text: 'تاریخ (شمسی)'
                    }
                },
                yaxis: {
                    reversed: true,
                    title: {
                        text: 'رتبه'
                    },
                    min: 1,
                    max: 100
                },
                markers: {
                    size: 5
                },
                colors: ['#0d6efd'],
                title: {
                    text: `تاریخچه رتبه: ${keywordText}`,
                    align: 'center'
                },
                tooltip: {
                    y: {
                        formatter: function(value) {
                            return value ? `رتبه ${value}` : 'یافت نشد';
                        }
                    }
                }
            };

            chartInstance = new ApexCharts(document.querySelector("#chart"), options);
            chartInstance.render();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('خطا در دریافت داده‌های نمودار');
        });
}
</script>
{% endblock %}
