{% extends 'layout/layout.html' %}
{% load static %}
{% load jalali_filters %}

{% block title %}Ø¬Ø²Ø¦ÛŒØ§Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª {{ req.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-2 text-gray-800">Ø¬Ø²Ø¦ÛŒØ§Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª: {{ req.name }}</h1>
            <p>ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯: {{ req.created_date|jalali_datetime }}</p>
            <p>ÙˆØ¶Ø¹ÛŒØª: 
                {% if req.status == 'pending' %}
                    <span class="badge bg-secondary">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</span>
                {% elif req.status == 'running' %}
                    <span class="badge bg-primary">Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...</span>
                {% elif req.status == 'completed' %}
                    <span class="badge bg-success">âœ… ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</span>
                    {% if req.duration %}
                        <small>({{ req.duration }})</small>
                    {% endif %}
                {% elif req.status == 'failed' %}
                    <span class="badge bg-danger">âŒ Ù†Ø§Ù…ÙˆÙÙ‚</span>
                {% endif %}
            </p>
            
            {% if req.status == 'completed' %}
            <a href="?download=1" class="btn btn-success mb-3">
                ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ú©Ø³Ù„ Ø®Ø±ÙˆØ¬ÛŒ
            </a>
            {% endif %}
            
            <div class="alert alert-info">
                <strong>ğŸ“Š Ø®Ù„Ø§ØµÙ‡ Ù†ØªØ§ÛŒØ¬:</strong><br>
                ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„Ù…Ø§Øª: {{ unique_keywords|length }}<br>
                ØªØ¹Ø¯Ø§Ø¯ Ø±Ù‚Ø¨Ø§: {{ unique_competitors|length }}
            </div>
            
            <div class="table-responsive">
                <table class="table table-striped table-hover table-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>Ú©Ù„Ù…Ù‡ Ú©Ù„ÛŒØ¯ÛŒ</th>
                            {% for comp in unique_competitors %}
                            <th>{{ comp }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for keyword in unique_keywords %}
                        <tr>
                            <td><strong>{{ keyword }}</strong></td>
                            {% for comp in unique_competitors %}
                            <td>
                                {% for kw in keywords_data %}
                                    {% if kw.keyword == keyword and kw.competitor == comp %}
                                        {% if kw.link != "-" %}
                                            <a href="{{ kw.link }}" target="_blank" class="text-success">
                                                âœ… {{ kw.link|truncatechars:40 }}
                                            </a>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="alert alert-info mt-3">
                <strong>ğŸ“Œ ØªÙˆØ¶ÛŒØ­Ø§Øª ÙØ§ÛŒÙ„ Ø®Ø±ÙˆØ¬ÛŒ:</strong>
                <ul class="mb-0">
                    <li>Ù‡Ø± Ø³Ø·Ø± = ÛŒÚ© Ú©Ù„Ù…Ù‡ Ú©Ù„ÛŒØ¯ÛŒ</li>
                    <li>Ù‡Ø± Ø³ØªÙˆÙ† = ÛŒÚ© Ø±Ù‚ÛŒØ¨</li>
                    <li>âœ… = Ù„ÛŒÙ†Ú© Ù¾ÛŒØ¯Ø§ Ø´Ø¯Ù‡ | - = ÛŒØ§ÙØª Ù†Ø´Ø¯</li>
                </ul>
            </div>
            
            <a href="{% url 'gap_requests_list' %}" class="btn btn-secondary">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª</a>
        </div>
    </div>
</div>
{% endblock %}